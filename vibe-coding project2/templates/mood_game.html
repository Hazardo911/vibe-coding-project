{% extends "base.html" %}

{% block title %}Mood Booster Game - Smart Wellness Tracker{% endblock %}

{% block content %}
<div class="main-container">
    <div class="row">
        <div class="col-12 mb-4">
            <h1 class="text-center">
                <i class="fas fa-gamepad me-2 text-warning"></i>Mood Booster Game
            </h1>
            <p class="text-center text-muted">Pop the bubbles to boost your mood! 🎈</p>
        </div>
    </div>

    <div class="row">
        <!-- Game Area -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-smile me-2"></i>Bubble Pop Challenge</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="stats-card">
                                    <div class="stats-number text-primary" id="score">0</div>
                                    <div class="stats-label">Score</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stats-card">
                                    <div class="stats-number text-success" id="timeLeft">60</div>
                                    <div class="stats-label">Time Left</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stats-card">
                                    <div class="stats-number text-warning" id="bubblesPopped">0</div>
                                    <div class="stats-label">Bubbles Popped</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mb-3">
                        <button id="startGame" class="btn btn-primary btn-lg">
                            <i class="fas fa-play me-2"></i>Start Game
                        </button>
                        <button id="pauseGame" class="btn btn-warning btn-lg" style="display: none;">
                            <i class="fas fa-pause me-2"></i>Pause
                        </button>
                    </div>
                    
                    <div id="gameArea" class="game-area" style="display: none;">
                        <div id="bubbleContainer" class="bubble-container">
                            <!-- Bubbles will be generated here -->
                        </div>
                    </div>
                    
                    <div id="gameOver" class="text-center" style="display: none;">
                        <h3 class="text-success">Game Over!</h3>
                        <p class="lead">Final Score: <span id="finalScore">0</span></p>
                        <button id="playAgain" class="btn btn-primary">
                            <i class="fas fa-redo me-2"></i>Play Again
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Game Instructions -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>How to Play</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-mouse-pointer text-primary me-2"></i>
                            Click on bubbles to pop them
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-star text-warning me-2"></i>
                            Golden bubbles give bonus points
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-clock text-info me-2"></i>
                            You have 60 seconds to score as much as possible
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-heart text-danger me-2"></i>
                            Have fun and boost your mood!
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Mood Tips -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Mood Boost Tips</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-success">
                        <h6><i class="fas fa-smile me-2"></i>Why This Game Helps</h6>
                        <ul class="mb-0">
                            <li>Engages your mind in a fun activity</li>
                            <li>Provides instant gratification</li>
                            <li>Helps distract from negative thoughts</li>
                            <li>Gives you a sense of accomplishment</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('mood') }}" class="btn btn-outline-success">
                            <i class="fas fa-smile me-2"></i>Log Your Mood
                        </a>
                        <a href="{{ url_for('tips') }}" class="btn btn-outline-info">
                            <i class="fas fa-lightbulb me-2"></i>Get More Tips
                        </a>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                            <i class="fas fa-home me-2"></i>Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.game-area {
    position: relative;
    height: 400px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    overflow: hidden;
    cursor: pointer;
}

.bubble-container {
    position: relative;
    width: 100%;
    height: 100%;
}

.bubble {
    position: absolute;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    animation: float 3s ease-in-out infinite;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

.bubble:hover {
    transform: scale(1.1);
}

.bubble.golden {
    background: radial-gradient(circle, #ffd700, #ffed4e);
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
}

.bubble.regular {
    background: radial-gradient(circle, #87CEEB, #4682B4);
    box-shadow: 0 0 15px rgba(135, 206, 235, 0.6);
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

.bubble.popped {
    animation: pop 0.3s ease-out;
}

@keyframes pop {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.5); opacity: 0.7; }
    100% { transform: scale(0); opacity: 0; }
}

.score-popup {
    position: absolute;
    color: #ffd700;
    font-weight: bold;
    font-size: 1.2rem;
    pointer-events: none;
    animation: scoreFloat 1s ease-out forwards;
}

@keyframes scoreFloat {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-50px); opacity: 0; }
}
</style>
{% endblock %}

{% block scripts %}
<script>
class BubbleGame {
    constructor() {
        this.score = 0;
        this.timeLeft = 60;
        this.bubblesPopped = 0;
        this.gameRunning = false;
        this.gameTimer = null;
        this.bubbleTimer = null;
        this.bubbles = [];
        
        this.initializeElements();
        this.bindEvents();
    }
    
    initializeElements() {
        this.startBtn = document.getElementById('startGame');
        this.pauseBtn = document.getElementById('pauseGame');
        this.gameArea = document.getElementById('gameArea');
        this.bubbleContainer = document.getElementById('bubbleContainer');
        this.scoreElement = document.getElementById('score');
        this.timeElement = document.getElementById('timeLeft');
        this.bubblesElement = document.getElementById('bubblesPopped');
        this.gameOverElement = document.getElementById('gameOver');
        this.finalScoreElement = document.getElementById('finalScore');
        this.playAgainBtn = document.getElementById('playAgain');
    }
    
    bindEvents() {
        this.startBtn.addEventListener('click', () => this.startGame());
        this.pauseBtn.addEventListener('click', () => this.pauseGame());
        this.playAgainBtn.addEventListener('click', () => this.resetGame());
        this.bubbleContainer.addEventListener('click', (e) => this.handleBubbleClick(e));
    }
    
    startGame() {
        this.gameRunning = true;
        this.startBtn.style.display = 'none';
        this.pauseBtn.style.display = 'inline-block';
        this.gameArea.style.display = 'block';
        this.gameOverElement.style.display = 'none';
        
        this.startTimer();
        this.startBubbleGeneration();
    }
    
    pauseGame() {
        this.gameRunning = false;
        this.startBtn.style.display = 'inline-block';
        this.pauseBtn.style.display = 'none';
        
        clearInterval(this.gameTimer);
        clearInterval(this.bubbleTimer);
    }
    
    startTimer() {
        this.gameTimer = setInterval(() => {
            this.timeLeft--;
            this.timeElement.textContent = this.timeLeft;
            
            if (this.timeLeft <= 0) {
                this.endGame();
            }
        }, 1000);
    }
    
    startBubbleGeneration() {
        this.bubbleTimer = setInterval(() => {
            if (this.gameRunning) {
                this.createBubble();
            }
        }, 1000);
    }
    
    createBubble() {
        const bubble = document.createElement('div');
        const size = Math.random() * 40 + 30; // 30-70px
        const isGolden = Math.random() < 0.2; // 20% chance for golden bubble
        
        bubble.className = `bubble ${isGolden ? 'golden' : 'regular'}`;
        bubble.style.width = size + 'px';
        bubble.style.height = size + 'px';
        bubble.style.left = Math.random() * (this.bubbleContainer.offsetWidth - size) + 'px';
        bubble.style.top = this.bubbleContainer.offsetHeight + 'px';
        bubble.style.animationDelay = Math.random() * 2 + 's';
        
        bubble.innerHTML = isGolden ? '⭐' : '💧';
        
        this.bubbleContainer.appendChild(bubble);
        this.bubbles.push(bubble);
        
        // Animate bubble floating up
        setTimeout(() => {
            bubble.style.transition = 'top 4s linear';
            bubble.style.top = '-50px';
        }, 100);
        
        // Remove bubble after animation
        setTimeout(() => {
            if (bubble.parentNode) {
                bubble.parentNode.removeChild(bubble);
                this.bubbles = this.bubbles.filter(b => b !== bubble);
            }
        }, 4000);
    }
    
    handleBubbleClick(e) {
        if (!this.gameRunning) return;
        
        const bubble = e.target.closest('.bubble');
        if (!bubble) return;
        
        // Calculate score
        const isGolden = bubble.classList.contains('golden');
        const points = isGolden ? 10 : 5;
        
        this.score += points;
        this.bubblesPopped++;
        
        // Update display
        this.scoreElement.textContent = this.score;
        this.bubblesElement.textContent = this.bubblesPopped;
        
        // Show score popup
        this.showScorePopup(bubble, points);
        
        // Pop animation
        bubble.classList.add('popped');
        setTimeout(() => {
            if (bubble.parentNode) {
                bubble.parentNode.removeChild(bubble);
                this.bubbles = this.bubbles.filter(b => b !== bubble);
            }
        }, 300);
    }
    
    showScorePopup(bubble, points) {
        const popup = document.createElement('div');
        popup.className = 'score-popup';
        popup.textContent = `+${points}`;
        popup.style.left = bubble.offsetLeft + bubble.offsetWidth / 2 + 'px';
        popup.style.top = bubble.offsetTop + 'px';
        
        this.bubbleContainer.appendChild(popup);
        
        setTimeout(() => {
            if (popup.parentNode) {
                popup.parentNode.removeChild(popup);
            }
        }, 1000);
    }
    
    endGame() {
        this.gameRunning = false;
        clearInterval(this.gameTimer);
        clearInterval(this.bubbleTimer);
        
        this.gameArea.style.display = 'none';
        this.startBtn.style.display = 'inline-block';
        this.pauseBtn.style.display = 'none';
        this.gameOverElement.style.display = 'block';
        this.finalScoreElement.textContent = this.score;
        
        // Save score
        this.saveScore();
        
        // Clear bubbles
        this.bubbles.forEach(bubble => {
            if (bubble.parentNode) {
                bubble.parentNode.removeChild(bubble);
            }
        });
        this.bubbles = [];
    }
    
    resetGame() {
        this.score = 0;
        this.timeLeft = 60;
        this.bubblesPopped = 0;
        
        this.scoreElement.textContent = this.score;
        this.timeElement.textContent = this.timeLeft;
        this.bubblesElement.textContent = this.bubblesPopped;
        
        this.startGame();
    }
    
    async saveScore() {
        try {
            const response = await fetch('/api/game-score', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ score: this.score })
            });
            
            const data = await response.json();
            if (data.success) {
                showMessage(data.message, 'success');
                setTimeout(() => {
                    showMessage(data.encouragement, 'info');
                }, 2000);
            }
        } catch (error) {
            console.error('Error saving score:', error);
        }
    }
}

// Initialize game when page loads
document.addEventListener('DOMContentLoaded', function() {
    new BubbleGame();
});
</script>
{% endblock %}
