{% extends "base.html" %}

{% block title %}Nutrition Tracker - Smart Wellness Tracker{% endblock %}

{% block content %}
<div class="main-container">
    <div class="row">
        <div class="col-12 mb-4">
            <h1 class="text-center">
                <i class="fas fa-apple-alt me-2 text-success"></i>Nutrition Tracker
            </h1>
            <p class="text-center text-muted">Track your daily nutrition and maintain a healthy diet</p>
        </div>
    </div>

    <div class="row">
        <!-- Nutrition Logging -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Log Your Food</h5>
                </div>
                <div class="card-body">
                    <form id="nutritionForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="foodName" class="form-label">Food Item</label>
                                <input type="text" class="form-control" id="foodName" name="food_name" 
                                       placeholder="e.g., apple, chicken breast, oatmeal" required>
                                <div class="form-text">Enter the food item and we'll fetch its nutritional information</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="mealType" class="form-label">Meal Type</label>
                                <select class="form-select" id="mealType" name="meal_type" required>
                                    <option value="">Select meal</option>
                                    <option value="breakfast">Breakfast</option>
                                    <option value="lunch">Lunch</option>
                                    <option value="dinner">Dinner</option>
                                    <option value="snack">Snack</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="mealTime" class="form-label">Time</label>
                                <input type="time" class="form-control" id="mealTime" name="time" 
                                       value="{{ now.strftime('%H:%M') }}">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-save me-2"></i>Log Food Item
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Today's Nutrition Summary -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Today's Nutrition Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="stats-card">
                                <div class="stats-number text-danger">{{ today_nutrition.calories }}</div>
                                <div class="stats-label">Calories</div>
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-danger" style="width: {{ (today_nutrition.calories / user_data.goals.daily_calories * 100) | min(100) }}%"></div>
                                </div>
                                <small class="text-muted">Goal: {{ user_data.goals.daily_calories }} cal</small>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stats-card">
                                <div class="stats-number text-primary">{{ "%.1f"|format(today_nutrition.protein) }}</div>
                                <div class="stats-label">Protein (g)</div>
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-primary" style="width: {{ (today_nutrition.protein / user_data.goals.daily_protein * 100) | min(100) }}%"></div>
                                </div>
                                <small class="text-muted">Goal: {{ user_data.goals.daily_protein }}g</small>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stats-card">
                                <div class="stats-number text-warning">{{ "%.1f"|format(today_nutrition.carbs) }}</div>
                                <div class="stats-label">Carbs (g)</div>
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-warning" style="width: {{ (today_nutrition.carbs / user_data.goals.daily_carbs * 100) | min(100) }}%"></div>
                                </div>
                                <small class="text-muted">Goal: {{ user_data.goals.daily_carbs }}g</small>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stats-card">
                                <div class="stats-number text-info">{{ "%.1f"|format(today_nutrition.fat) }}</div>
                                <div class="stats-label">Fat (g)</div>
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-info" style="width: {{ (today_nutrition.fat / user_data.goals.daily_fat * 100) | min(100) }}%"></div>
                                </div>
                                <small class="text-muted">Goal: {{ user_data.goals.daily_fat }}g</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nutrition Charts -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Weekly Nutrition Trends</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="nutritionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Today's Meals -->
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-utensils me-2"></i>Today's Meals</h5>
                </div>
                <div class="card-body">
                    {% set today_meals = [] %}
                    {% for log in user_data.nutrition_logs %}
                        {% if log.date == now.strftime('%Y-%m-%d') %}
                            {% for meal in log.meals %}
                                {% set _ = today_meals.append(meal) %}
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if today_meals %}
                        <div class="list-group">
                            {% for meal in today_meals %}
                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        <h6 class="mb-1">{{ meal.name }}</h6>
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>{{ meal.time }} - {{ meal.meal_type.title() }}
                                        </small>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="row text-center">
                                            <div class="col-2">
                                                <small class="text-danger fw-bold">{{ meal.calories }}</small>
                                                <div class="text-muted small">Cal</div>
                                            </div>
                                            <div class="col-2">
                                                <small class="text-primary fw-bold">{{ "%.1f"|format(meal.protein) }}</small>
                                                <div class="text-muted small">Protein</div>
                                            </div>
                                            <div class="col-2">
                                                <small class="text-warning fw-bold">{{ "%.1f"|format(meal.carbs) }}</small>
                                                <div class="text-muted small">Carbs</div>
                                            </div>
                                            <div class="col-2">
                                                <small class="text-info fw-bold">{{ "%.1f"|format(meal.fat) }}</small>
                                                <div class="text-muted small">Fat</div>
                                            </div>
                                            <div class="col-2">
                                                <small class="text-success fw-bold">{{ "%.1f"|format(meal.fiber) }}</small>
                                                <div class="text-muted small">Fiber</div>
                                            </div>
                                            <div class="col-2">
                                                <small class="text-secondary fw-bold">{{ "%.1f"|format(meal.sugar) }}</small>
                                                <div class="text-muted small">Sugar</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-apple-alt fa-3x mb-3"></i>
                            <p>No meals logged today. Start tracking your nutrition!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Food Logging -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Log</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-success" onclick="quickLog('apple')">
                            <i class="fas fa-apple-alt me-2"></i>Apple
                        </button>
                        <button class="btn btn-outline-success" onclick="quickLog('banana')">
                            <i class="fas fa-banana me-2"></i>Banana
                        </button>
                        <button class="btn btn-outline-success" onclick="quickLog('chicken breast')">
                            <i class="fas fa-drumstick-bite me-2"></i>Chicken Breast
                        </button>
                        <button class="btn btn-outline-success" onclick="quickLog('salmon')">
                            <i class="fas fa-fish me-2"></i>Salmon
                        </button>
                        <button class="btn btn-outline-success" onclick="quickLog('oatmeal')">
                            <i class="fas fa-bread-slice me-2"></i>Oatmeal
                        </button>
                        <button class="btn btn-outline-success" onclick="quickLog('yogurt')">
                            <i class="fas fa-mug-hot me-2"></i>Yogurt
                        </button>
                    </div>
                </div>
            </div>

            <!-- Nutrition Tips -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Nutrition Tips</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-heart me-2"></i>Healthy Eating Tips</h6>
                        <ul class="mb-0">
                            <li>Eat a variety of colorful fruits and vegetables</li>
                            <li>Include lean protein in every meal</li>
                            <li>Choose whole grains over refined grains</li>
                            <li>Stay hydrated throughout the day</li>
                            <li>Limit added sugars and processed foods</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Macro Distribution -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Macro Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="macroChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('habits') }}" class="btn btn-outline-primary">
                            <i class="fas fa-tasks me-2"></i>Log Habits
                        </a>
                        <a href="{{ url_for('mood') }}" class="btn btn-outline-success">
                            <i class="fas fa-smile me-2"></i>Log Mood
                        </a>
                        <a href="{{ url_for('tips') }}" class="btn btn-outline-info">
                            <i class="fas fa-lightbulb me-2"></i>Get Tips
                        </a>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-home me-2"></i>Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const nutritionForm = document.getElementById('nutritionForm');
    
    // Handle form submission
    nutritionForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('/log_nutrition', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                nutritionForm.reset();
                setTimeout(() => location.reload(), 1000);
            } else {
                showMessage(data.error || 'Error logging nutrition', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Error logging nutrition', 'danger');
        });
    });
    
    // Load charts
    loadNutritionChart();
    loadMacroChart();
});

function quickLog(foodItem) {
    const form = document.getElementById('nutritionForm');
    document.getElementById('foodName').value = foodItem;
    document.getElementById('mealType').value = 'snack';
    form.dispatchEvent(new Event('submit'));
}

function loadNutritionChart() {
    fetch('/api/nutrition_data')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('nutritionChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: 'Calories',
                        data: data.calories,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Protein (g)',
                        data: data.protein,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Carbs (g)',
                        data: data.carbs,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Fat (g)',
                        data: data.fat,
                        borderColor: '#0dcaf0',
                        backgroundColor: 'rgba(13, 202, 240, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Weekly Nutrition Trends'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error loading nutrition chart:', error));
}

function loadMacroChart() {
    const todayNutrition = {
        protein: {{ today_nutrition.protein }},
        carbs: {{ today_nutrition.carbs }},
        fat: {{ today_nutrition.fat }}
    };
    
    const ctx = document.getElementById('macroChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Protein', 'Carbs', 'Fat'],
            datasets: [{
                data: [todayNutrition.protein, todayNutrition.carbs, todayNutrition.fat],
                backgroundColor: [
                    '#0d6efd',
                    '#ffc107',
                    '#0dcaf0'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}
</script>
{% endblock %}
